---
import { marked } from 'marked';
import SiteHeader from '../../components/SiteHeader.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostInfoBox from '../../components/PostInfoBox.astro';
import { CATEGORIES } from '../../lib/categories';
import { formatDate } from '../../lib/date';
import { href } from '../../lib/href';
import { getAllPosts, getPostBySlug } from '../../lib/posts';
import { getAllRedirectSlugs, getRedirectTarget } from '../../lib/redirects';
import { encodeTag } from '../../lib/tagCodec';
import { withBaseInHtml } from '../../lib/withBaseInHtml';

export function getStaticPaths() {
  const posts = getAllPosts({ includeDrafts: import.meta.env.DEV });
  const postSlugs = new Set(posts.map((post) => post.slug));
  const redirectSlugs = getAllRedirectSlugs().filter((slug) => !postSlugs.has(slug));

  return [...postSlugs, ...redirectSlugs].map((slug) => ({ params: { slug } }));
}

const slug = Astro.params.slug;
const post = slug ? getPostBySlug(slug, { includeDrafts: import.meta.env.DEV }) : undefined;

const redirectTarget = slug && !post ? getRedirectTarget(slug) : null;
const redirectHref = redirectTarget ? href(`/p/${redirectTarget}/`) : null;
const isRedirectPage = Boolean(!post && redirectTarget && redirectHref);

const categoryLabel = post
  ? CATEGORIES.find((category) => category.slug === post.category)?.label ?? post.category
  : '';

const html = post ? withBaseInHtml(marked.parse(post.contentMd) as string) : '';
const canonicalPath = post
  ? `/p/${post.slug}/`
  : redirectTarget
    ? `/p/${redirectTarget}/`
    : '/';

const canonicalUrl = Astro.site ? new URL(href(canonicalPath), Astro.site).toString() : undefined;
const ogImagePath = post ? (post.ogImage || post.thumbnail) : undefined;
const ogImageUrl = ogImagePath && Astro.site ? new URL(href(ogImagePath), Astro.site).toString() : undefined;

const jsonLd = post
  ? {
      '@context': 'https://schema.org',
      '@type': 'Article',
      headline: post.title,
      description: post.summary,
      datePublished: post.publishedAt,
      dateModified: post.updatedAt ?? post.publishedAt,
      image: ogImageUrl ? [ogImageUrl] : undefined,
      mainEntityOfPage: canonicalUrl,
      publisher: {
        '@type': 'Organization',
        name: '복지정보.com',
      },
    }
  : null;
---

<BaseLayout
  title={post ? `${post.title} | 복지정보.com` : '이동 중… | 복지정보.com'}
  description={post ? post.summary : '문서가 새 주소로 이동했습니다.'}
  canonicalPath={canonicalPath}
  ogImagePath={ogImagePath}
  ogType={post ? 'article' : 'website'}
  noindex={isRedirectPage}
>
  {
    isRedirectPage ? (
      <>
        <meta http-equiv="refresh" content={`0;url=${redirectHref}`} />
        <script type="module" define:vars={{ redirectHref }}>
          window.location.replace(redirectHref);
        </script>
        <section class="mx-auto mt-20 max-w-xl rounded-2xl border border-slate-200 bg-white p-6 text-center shadow-sm">
          <h1 class="text-xl font-bold text-slate-900">페이지 이동 안내</h1>
          <p class="mt-2 text-sm text-slate-600">요청하신 글이 새 주소로 이동했습니다.</p>
          <a href={redirectHref || href('/')} class="mt-4 inline-flex text-sm font-semibold text-sky-700 hover:underline">
            새 주소로 이동하기
          </a>
        </section>
      </>
    ) : post ? (
      <>
        <SiteHeader />
        <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:p-8">
          <header class="space-y-3 border-b border-slate-200 pb-5">
            <p class="text-sm font-semibold text-sky-700">{categoryLabel}</p>
            <h1 class="text-2xl font-bold text-slate-900 sm:text-3xl">{post.title}</h1>
            <p class="text-sm text-slate-600">{post.summary}</p>
            <div class="flex flex-wrap gap-1.5">
              {post.tags.map((tag) => (
                <a
                  href={href(`/tag/${encodeTag(tag)}/`)}
                  class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-700 hover:bg-slate-200"
                >
                  #{tag}
                </a>
              ))}
            </div>
            <p class="text-xs text-slate-500">발행일: {formatDate(post.publishedAt)}</p>
          </header>

          <PostInfoBox post={post} />

          <article class="prose prose-slate mt-6 max-w-none" set:html={html}></article>

          <footer class="mt-8 border-t border-slate-200 pt-5">
            <a href={href(`/c/${post.category}/`)} class="text-sm font-semibold text-sky-700 hover:underline">
              목록으로
            </a>
          </footer>
        </article>

        {jsonLd && <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>}
      </>
    ) : (
      <section class="mx-auto mt-20 max-w-xl rounded-2xl border border-slate-200 bg-white p-6 text-center shadow-sm">
        <h1 class="text-xl font-bold text-slate-900">문서를 찾을 수 없습니다</h1>
        <a href={href('/')} class="mt-4 inline-flex text-sm font-semibold text-sky-700 hover:underline">
          홈으로 이동
        </a>
      </section>
    )
  }
</BaseLayout>
