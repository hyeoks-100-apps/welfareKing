---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import SiteHeader from '../../../components/SiteHeader.astro';
import PostCard from '../../../components/PostCard.astro';
import PaginationNav from '../../../components/PaginationNav.astro';
import { CATEGORIES, type CategorySlug } from '../../../lib/categories';
import { href } from '../../../lib/href';
import { PAGE_SIZE, sliceByPage, totalPages } from '../../../lib/pagination';
import { getPostsByCategory } from '../../../lib/posts';
import { sortByDeadline } from '../../../lib/sortPosts';

export function getStaticPaths() {
  return CATEGORIES.map((category) => ({
    params: { category: category.slug },
    props: { category },
  }));
}

const { category } = Astro.props as { category: { slug: CategorySlug; label: string } };
const allPosts = sortByDeadline(getPostsByCategory(category.slug));
const pagePosts = sliceByPage(allPosts, 1, PAGE_SIZE);
const pages = totalPages(allPosts.length, PAGE_SIZE);
---

<BaseLayout
  title={`${category.label} 마감 임박순 | 복지정보.com`}
  description={`${category.label} 카테고리 마감 임박순 목록`}
  canonicalPath={`/c/${category.slug}/deadline/`}
>
  <SiteHeader />
  <section class="space-y-2 pb-4">
    <h1 class="text-2xl font-bold text-slate-900 sm:text-3xl">{category.label}</h1>
    <p class="text-sm text-slate-600">마감 임박순 · 오늘/예정 마감 우선</p>
    <div class="flex gap-2">
      <a href={href(`/c/${category.slug}/`)} class="rounded-full bg-slate-100 px-3 py-1.5 text-sm font-semibold text-slate-700 hover:bg-slate-200">최신순</a>
      <a href={href(`/c/${category.slug}/deadline/`)} class="rounded-full bg-slate-900 px-3 py-1.5 text-sm font-semibold text-white">마감 임박순</a>
    </div>
  </section>

  {
    pagePosts.length > 0 ? (
      <>
        <section class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {pagePosts.map((post) => <PostCard post={post} />)}
        </section>
        <PaginationNav basePath={`/c/${category.slug}/deadline/`} currentPage={1} totalPages={pages} />
      </>
    ) : (
      <p class="rounded-xl border border-dashed border-slate-300 bg-white p-6 text-slate-500">아직 등록된 글이 없습니다.</p>
    )
  }
</BaseLayout>
